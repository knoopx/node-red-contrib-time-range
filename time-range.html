<script type="text/javascript">
/* global RED */
/* global $ */

function makeEditableList(selector, items = []) {
  const list = $(selector)
    .css("min-height", "200px")
    .editableList({
      addItem(container, i, item) {
        $("<input/>", {
          class: "node-input-item-value",
          style: "width:100%",
          type: "text",
        })
          .val(item.value)
          .wrap("<div/>")
          .appendTo(container)
      },
      removable: true,
      sortable: true,
    })

  items.forEach((item) => {
    list.editableList("addItem", item)
  })
}

function getEditableListValues(selector) {
  const values = []
  $(selector)
    .editableList("items")
    .each((i, el) => {
      values.push({ value: el.find(".node-input-item-value").val() })
    })
  return values
}

RED.nodes.registerType("time range", {
  category: "function",
  color: "#e2d96e",
  defaults: {
    name: { value: "" },
    domain: {
      value: [{ value: "" }],
    },
    range: {
      value: [{ value: "" }],
    },
  },
  inputs: 1,
  outputs: 1,
  icon: "range.svg",

  label() {
    return this.name || "time range"
  },
  oneditprepare() {
    makeEditableList("#node-input-domain-container", this.domain)
    makeEditableList("#node-input-range-container", this.range)
  },
  oneditsave() {
    this.domain = getEditableListValues("#node-input-domain-container")
    this.range = getEditableListValues("#node-input-range-container")
  },
})
</script>

<script type="text/html" data-template-name="time range">
    <div class="form-row node-input-domain-container-row">
        <label>Domain</label>
        <ol id="node-input-domain-container"></ol>
    </div>
    <div class="form-row node-input-range-container-row">
        <label>Range</label>
        <ol id="node-input-range-container"></ol>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
</script>

<script type="text/html" data-help-name="time range">
    <p>maps a time domain to the specified range. accepts suncalc time notation.</p>

    <code>
      {
        "location": {
            "latitude": 41.5094309,
            "longitude": 2.3872923
         },
        "domain": ["00:00", "sunrise", "dusk", "23:59"],
        "range": [127, 255, 255, 127]
     }
    </code>
</script>